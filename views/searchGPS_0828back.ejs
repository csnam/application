<!-- 위치 기반으로 검색 -->

<!DOCTYPE HTML>
<html lang="en">
<head>

<title>Search Exchange Shop </title>
<meta name="viewport" content="initial-scale=1.0">
<meta charset="utf-8">

<style>
    #map {
      width: 80%;
      height: 100%;
      background-color: grey;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {
      height: 90%;
      margin: 0;
      padding: 0;
    }
    #transactionTable { 
      border-collapse:collapse;
      border: 1px solid black;
    }

    th,td{
      border: 1px solid black;
    }
 </style>
    <script type="text/javascript" src="scripts/jquery.js"></script>

</head>
    
<body>
  <div id="map"></div>
  <p>
      <b> 적립 가능한 상점 리스트  </b>
      <table id="transactionTable"></table>

  </p>
 
  <script>
    var localserivce=0;
    var locations = [
        {lat: 37.497160, lng: 127.122604},
        {lat: 37.497160, lng: 127.122614},
        {lat: 37.496882, lng: 127.122624},
        {lat: 37.495265, lng: 127.121538},
        {lat: 37.494524, lng: 127.120229},
        {lat: 37.494514, lng: 127.130626},
        {lat: 37.494534, lng: 127.130616},
        {lat: 37.491544, lng: 127.120646},
        {lat: 37.491554, lng: 127.120656},
        {lat: 37.491564, lng: 127.120666},
        {lat: 37.494564, lng: 127.120766},
        {lat: 37.494464, lng: 127.121566},
        {lat: 37.493464, lng: 127.122566},
        {lat: 37.491464, lng: 127.125566},
    ]
     //37.494472, 127.121060

    function makeMap(position){
     
      //position.coords.latitude= 37.494991;
      //position.coords.longitude= 127.122390;   // 왜 안되는 지.
      if(localserivce){ 
          var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 16,
          center: {lat: position.coords.latitude, lng: position.coords.longitude}
          });
      }
      else {
          var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 16,
          center: {lat: 37.494991, lng: 127.122390}
          }); 
      }
      // 핀테크 지원센터 테스트용 강제지정
      setMarkers(map);
   }
  function ShowStoreList(data){
      var resultList = data;
      console.log(resultList);
      for (let i = 0; i < resultList.length; i++) {
          console.log("for loop ==" + i);
          const element = resultList[i];
          $("#transactionTable").append(
              '<tr>' +
              '<td>'+element.No+'</td>' +
              '<td>'+element.store_id+'</td>' +
              '<td>'+element.name+'</td>' +
              '<td>'+element.store_sort+'</td>' +
              '<td>'+element.telno+'</td>' +
              '<td>'+element.country+'</td>' +
              '<td>'+element.address+'</td>' +
              '<td>'+element.latitude+'</td>' +
              '<td>'+element.longtitude+'</td>' +
              '</tr>'
          )
      }
  }
  function initMap() {
    //---
    $.ajax({
            url:'http://localhost:3000/getStoreGpsData',
            type : 'POST',
            data : {
          },
          success:function(data){
              console.log("initMap success ===============");
              ShowStoreList(data);
              
          }
      })

    if(localserivce){ 
      navigator.geolocation.getCurrentPosition(success, error, options);
      console.log(position);
    }
    else {
      var position=0;
      makeMap(position);  //핀테크 지원센터 테스트용 강제지정
    }
  }

    var options = {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    };

    function success(pos) {
      var crd = pos.coords;
      // console.log('Your current position is:');
      // console.log('Latitude : ' + crd.latitude);
      // console.log('Longitude: ' + crd.longitude);
      // console.log('More or less ' + crd.accuracy + ' meters.');
        makeMap(pos);
    };

    function error(err) {
      console.log('ERROR(' + err.code + '): ' + err.message);
    };
    
  
    function setMarkers(map) {
      var image = {
        url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
        size: new google.maps.Size(20, 32),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(0, 32)
      };
      var shape = {
        coords: [1, 1, 1, 20, 18, 20, 18, 1],
        type: 'poly'
      };
      console.log("setMarkers start ------------");


      for (var i = 0; i < locations.length; i++) {
         var marker = new google.maps.Marker({
          position: {lat: locations[i].lat, lng: locations[i].lng},
          map: map,
          icon: image,
          shape: shape,
          title: "A"+ i
        });
       
        google.maps.event.addListener(marker,'click',function(){

          var infowindow = new google.maps.InfoWindow({
            content: getOpenWindowData("헤라 쇼핑("+ this.title+")")
          });
            console.log(this.title);
            infowindow.open(map, marker)
     
        });
      }
      console.log("setMarkers result ------------"  );
      console.log("Markers resultd --"   );
      console.log("map  result --" );



      // var markerCluster = new MarkerClusterer(map, marker, 
      //   {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
    }


    function getOpenWindowData(storeName){
        var contentString = '<div id="content">'+
        '<div id="siteNotice">'+
        '</div>'+
        '<h1 id="firstHeading" class="firstHeading">+' + storeName +'</h1>'+
        '<div id="bodyContent">'+
        '<p><b>해외 동전 적립 서비스 가능</b><br>' +
        '주소 : 서울시 송파구 송파대로 1301 <br> '+
        '전화 번호: 121-1212.<br>' +
        '영업시간: 08:00 ~ 20:00 <br></p>'+
        '<p>주요 상품 <br> ' +
        '화장품, 향수, 면도기,세안용품,치약 <br>'  +  '<a href="http://www.11st.co.kr/html/bestSellerMain3.html?prdNo=968909099">'+
        'http://www.11st.co.kr/html/bestSellerMain3.html?prdNo=968909099</a> '+
        '</p>'+
        '</div>'+
        '</div>';

        return contentString
    }
    

  </script>

  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMq3ynwd0frB5IdCmgeLZ_baBumJBq65o&callback=initMap"
          async defer>
  </script>
</body>


</html>